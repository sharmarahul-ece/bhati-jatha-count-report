@model bhati_jatha_count_report.Models.ViewModels.DailyActualCountPageViewModel
@{
  ViewData["Title"] = "Manage Daily Actual Counts";
}
<div class="container">
  <h2 class="mb-4">Manage Daily Actual Counts</h2>
  <div class="mb-3 position-relative" style="display: flex; align-items: center; gap: 0.5rem;">
    <button type="button" class="btn btn-outline-secondary btn-sm" id="copyPendingSrsBtn">
      <i class="bi bi-clipboard"></i> Copy Pending SRS Token
    </button>
    <span id="copyDoneAnim" style="display:none; color: green; font-weight: bold; transition: opacity 0.3s;">Copied!</span>
  </div>
  <form class="row row-cols-lg-auto g-2 align-items-center mb-3" onsubmit="return false;">
    <div class="col-auto">
      <label class="form-label mb-0 me-2" for="filterCenter">Center</label>
      <select id="filterCenter" class="form-select form-select-sm d-inline-block w-auto align-middle">
        <option value="">All</option>
        @foreach (var c in Model.Centers)
        {
          <option value="@c.Id">@c.CenterName</option>
        }
      </select>
    </div>
    <div class="col-auto">
      <label class="form-label mb-0 me-2" for="filterSewaType">Sewa Type</label>
      <select id="filterSewaType" class="form-select form-select-sm d-inline-block w-auto align-middle">
        <option value="">All</option>
        @foreach (var s in Model.SewaTypes)
        {
          <option value="@s.Id">@s.SewaName</option>
        }
      </select>
    </div>
    <div class="col-auto">
      <label class="form-label mb-0 me-2" for="filterDateFrom">Date From</label>
      <input type="date" id="filterDateFrom" class="form-control form-control-sm d-inline-block w-auto align-middle" />
    </div>
    <div class="col-auto">
      <label class="form-label mb-0 me-2" for="filterDateTo">Date To</label>
      <input type="date" id="filterDateTo" class="form-control form-control-sm d-inline-block w-auto align-middle" />
    </div>
    <div class="col-auto d-flex gap-2 align-items-center">
      <!-- Apply Filters button removed: filters now apply automatically -->
      <button type="button" class="btn btn-primary btn-sm align-middle" data-bs-toggle="modal" data-bs-target="#dacModal" onclick="resetForm()">
        <i class="bi bi-plus-circle"></i> Add Record
      </button>
    </div>
  </form>
  <div class="table-responsive">
    <table class="table table-sm table-striped table-hover" id="dacTable">
      <thead class="table-light">
        <tr>
          <th>Date</th>
          <th>Center</th>
          <th>Sewa Type</th>
          <th>Count</th>
          <th>SRS Count</th>
          <th>SRS Token</th>
          <th class="d-none">SRS Found</th>
          <th>Remarks</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="dacTableBody">
        <!-- Rows will be rendered by JS -->
      </tbody>
    </table>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="dacModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Add Record</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="dacForm">
            <input type="hidden" id="dacId" />
            @Html.AntiForgeryToken()
            <div class="mb-3">
              <label for="dacDate" class="form-label">Date</label>
              <input type="date" class="form-control" id="dacDate" required />
            </div>
            <div class="mb-3">
              <label for="dacCenterId" class="form-label">Center</label>
              <select class="form-select" id="dacCenterId" required>
                <option value="">Select Center</option>
                @foreach (var c in Model.Centers)
                {
                  <option value="@c.Id">@c.CenterName</option>
                }
              </select>
            </div>
            <div class="mb-3">
              <label for="dacSewaTypeId" class="form-label">Sewa Type</label>
              <select class="form-select" id="dacSewaTypeId" required>
                <option value="">Select Sewa Type</option>
                @foreach (var s in Model.SewaTypes)
                {
                  <option value="@s.Id">@s.SewaName</option>
                }
              </select>
            </div>
            <div class="mb-3">
              <label for="dacCount" class="form-label">Count</label>
              <input type="number" class="form-control" id="dacCount" required />
            </div>
            <div class="mb-3">
              <label for="dacNominalRollToken" class="form-label">SRS Token</label>
              <textarea class="form-control" id="dacNominalRollToken" rows="3" required></textarea>
            </div>
            <div class="mb-3">
              <label for="dacManualSewadarCount" class="form-label">Manual SRS Count</label>
              <input type="number" class="form-control" id="dacManualSewadarCount" min="0" />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary btn-sm" onclick="saveDac()">Save</button>
        </div>
      </div>
    </div>
  </div>
</div>

@section Scripts {
  <script>
    let isEditing = false;
    let dacData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.DailyActualCounts));
    // --- Copy Pending SRS Token logic ---
    document.addEventListener('DOMContentLoaded', function () {
      const copyBtn = document.getElementById('copyPendingSrsBtn');
      if (copyBtn) {
        copyBtn.addEventListener('click', function () {
          let data = dacData || [];
          let pending = data.filter(x => x.nominalRollFound === false || x.nominalRollFound === null || x.nominalRollFound === undefined);
          let lines = ['Pending SRS Token'];
          pending.forEach((item, idx) => {
            let centerName = '-';
            if (item.centerName) {
              centerName = item.centerName;
            } else if (item.center && item.center.centerName) {
              centerName = item.center.centerName;
            } else if (window.centers) {
              const c = window.centers.find(c => c.id === item.centerId);
              if (c) centerName = c.centerName;
            }
            let sewaTypeName = '-';
            if (item.sewaTypeName) {
              sewaTypeName = item.sewaTypeName;
            } else if (item.sewaType && item.sewaType.sewaName) {
              sewaTypeName = item.sewaType.sewaName;
            } else if (window.sewaTypes) {
              const s = window.sewaTypes.find(s => s.id === item.sewaTypeId);
              if (s) sewaTypeName = s.sewaName;
            }
            let srsToken = item.nominalRollToken ?? '-';
            lines.push(`${idx + 1}. ${centerName} - ${sewaTypeName} - ${srsToken}`);
          });
          const textToCopy = lines.join('\n');
          if (navigator.clipboard) {
            navigator.clipboard.writeText(textToCopy);
          } else {
            // fallback for older browsers
            const temp = document.createElement('textarea');
            temp.value = textToCopy;
            document.body.appendChild(temp);
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
          }
          // Show animation/feedback
          const anim = document.getElementById('copyDoneAnim');
          if (anim) {
            anim.style.display = 'inline';
            anim.style.opacity = 1;
            setTimeout(() => {
              anim.style.opacity = 0;
              setTimeout(() => { anim.style.display = 'none'; anim.style.opacity = 1; }, 400);
            }, 1200);
          }
        });
      }
    });
    function resetForm() {
      isEditing = false;
      document.getElementById('dacForm').reset();
      document.getElementById('dacId').value = '';
      // Set date to today if empty
      const dateInput = document.getElementById('dacDate');
      if (!dateInput.value) {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        dateInput.value = `${yyyy}-${mm}-${dd}`;
      }
      document.getElementById('modalTitle').textContent = 'Add Record';
    }

    // --- Filtering logic ---
    const centers = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Centers));
    const sewaTypes = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.SewaTypes));

    function renderTable(data) {
      const tbody = document.getElementById('dacTableBody');
      tbody.innerHTML = '';

      data.forEach(item => {
        // Calculate the displayed SRS Count (from nominal roll or manual override)
        const displaySewadarCount = item.nominalRollFound
          ? (item.nominalRollSewadarCount ?? 0)
          : (item.manualSewadarCount ?? 0);

        // Determine if there is a mismatch between Count and SRS Count
        const isMismatch = (item.count ?? 0) !== displaySewadarCount;

        // Row highlight if mismatch
        const rowHighlight = isMismatch ? 'background-color:#ffeaea;' : '';

        // Get display names for center and sewa type (prefer direct property, fallback to lookup)
        let centerName = '-';
        if (item.centerName) {
          centerName = item.centerName;
        } else if (item.center && item.center.centerName) {
          centerName = item.center.centerName;
        } else {
          const c = centers.find(c => c.id === item.centerId);
          if (c) centerName = c.centerName;
        }

        let sewaTypeName = '-';
        if (item.sewaTypeName) {
          sewaTypeName = item.sewaTypeName;
        } else if (item.sewaType && item.sewaType.sewaName) {
          sewaTypeName = item.sewaType.sewaName;
        } else {
          const s = sewaTypes.find(s => s.id === item.sewaTypeId);
          if (s) sewaTypeName = s.sewaName;
        }

        // SRS Found column
        const foundText = item.nominalRollFound ? 'Yes' : 'No';

        // Cell highlights
        const countCellStyle = isMismatch ? 'background-color:#ffeaea;' : 'background-color:#eaffea';
        const nominalRollTokenCellStyle = item.nominalRollFound ? 'background-color:#eaffea;' : 'background-color:#ffeaea;';
        const foundCellStyle = item.nominalRollFound ? 'background-color:#eaffea;' : 'background-color:#ffeaea;';

        // SRS Count cell (input if not found, else value)
        let srsCountCell = '';
        // Use the same style for both span and input
        if (item.nominalRollFound) {
          srsCountCell = `<span>${item.nominalRollSewadarCount ?? '-'}</span>`;
        } else {
          @* srsCountCell = `<input type='number' class='form-control form-control-sm manual-sewadar-count-input' data-id='${item.id}' value='${item.manualSewadarCount ?? ''}' min='0' style='width:90px;${sewadarCountCellStyle}' />`; *@
            srsCountCell = `<span>${item.manualSewadarCount ?? '-'}</span>`;
        }

        // Build the row HTML
        const tr = document.createElement('tr');
        tr.setAttribute('data-id', item.id);
        if (rowHighlight) tr.setAttribute('style', rowHighlight);
        tr.innerHTML = `
                  <td>${item.date ? item.date.substring(0, 10) : '-'}</td>
                  <td>${centerName}</td>
                  <td>${sewaTypeName}</td>
                  <td style='${countCellStyle}'>${item.count ?? '-'}</td>
                  <td style='${countCellStyle}'>${srsCountCell}</td>
                  <td style='${nominalRollTokenCellStyle}'>${item.nominalRollToken ?? '-'}</td>
                  <td class='d-none' style='${foundCellStyle}'>${foundText}</td>
                  <td style='${nominalRollTokenCellStyle}'>${item.nominalRollRemarks ? item.nominalRollRemarks : ''}</td>
                  <td>
                    <button class="btn btn-sm btn-primary me-2 edit-dac-btn" data-id="${item.id}">
                      <i class="bi bi-pencil"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-danger delete-dac-btn" data-id="${item.id}">
                      <i class="bi bi-trash"></i> Delete
                    </button>
                  </td>
                `;
        tbody.appendChild(tr);
      });

      // Add event listeners for manual override inputs
      document.querySelectorAll('.manual-sewadar-count-input').forEach(input => {
        input.addEventListener('change', function () {
          const id = this.getAttribute('data-id');
          const value = this.value;
          // Find the item in dacData and update
          const item = dacData.find(x => x.id == id);
          if (item) item.manualSewadarCount = value ? parseInt(value) : null;
        });
      });
    }

    function filterData() {
      const centerId = document.getElementById('filterCenter').value;
      const sewaTypeId = document.getElementById('filterSewaType').value;
      const dateFrom = document.getElementById('filterDateFrom').value;
      const dateTo = document.getElementById('filterDateTo').value;

      let url = '/DailyActualCount/GetFiltered?';
      if (dateFrom) url += `fromDate=${dateFrom}&`;
      if (dateTo) url += `toDate=${dateTo}&`;
      if (centerId) url += `centerId=${centerId}&`;
      if (sewaTypeId) url += `sewaTypeId=${sewaTypeId}`;

      fetch(url)
        .then(r => r.json())
        .then(res => {
          if (res.success) {
            dacData = res.data; // Update the local data
            renderTable(res.data);
          } else {
            alert('Error loading filtered data');
          }
        })
        .catch(err => {
          console.error('Error:', err);
          alert('Error loading filtered data');
        });
    }

    // Set default date filter to today, but show all data initially
    window.addEventListener('DOMContentLoaded', () => {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      const todayStr = `${yyyy}-${mm}-${dd}`;

      document.getElementById('filterDateFrom').value = todayStr;
      document.getElementById('filterDateTo').value = todayStr;

      filterData();
    });

  // Remove Apply Filters button event listener

  // Add change event listeners to filter inputs to auto-apply filters
  document.getElementById('filterCenter').addEventListener('change', filterData);
  document.getElementById('filterSewaType').addEventListener('change', filterData);
  document.getElementById('filterDateFrom').addEventListener('change', filterData);
  document.getElementById('filterDateTo').addEventListener('change', filterData);
    document.querySelector('#dacTable').addEventListener('click', function (e) {
      if (e.target.closest('.edit-dac-btn')) {
        const id = e.target.closest('.edit-dac-btn').dataset.id;
        fetch(`/DailyActualCount/Get/${id}`)
          .then(r => r.json())
          .then(res => {
            if (res.success) {
              const d = res.data;
              document.getElementById('dacId').value = d.id;
              document.getElementById('dacDate').value = d.date ? d.date.substring(0, 10) : '';
              document.getElementById('dacCenterId').value = d.centerId;
              document.getElementById('dacSewaTypeId').value = d.sewaTypeId;
              document.getElementById('dacCount').value = d.count;
              document.getElementById('dacNominalRollToken').value = d.nominalRollToken;
              document.getElementById('dacManualSewadarCount').value = d.manualSewadarCount ?? '';
              document.getElementById('modalTitle').textContent = 'Edit Record';
              new bootstrap.Modal(document.getElementById('dacModal')).show();
            }
          });
      }
      if (e.target.closest('.delete-dac-btn')) {
        const id = e.target.closest('.delete-dac-btn').dataset.id;
        if (confirm('Are you sure you want to delete this record?')) {
          const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
          fetch(`/DailyActualCount/Delete/${id}`, {
            method: 'DELETE',
            headers: { 'RequestVerificationToken': token }
          })
            .then(r => r.json())
            .then(res => {
              if (res.success) window.location.reload();
              else alert(res.message);
            });
        }
      }
    });
    function saveDac() {
      const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
      const id = document.getElementById('dacId').value || 0;
      let manualSewadarCount = null;
      // If editing, try to get manual override from table input
      if (id) {
        const input = document.querySelector(`.manual-sewadar-count-input[data-id='${id}']`);
        if (input) manualSewadarCount = input.value ? parseInt(input.value) : null;
      }
      // Prefer value from modal input if present
      let manualSewadarCountField = document.getElementById('dacManualSewadarCount');
      if (manualSewadarCountField && manualSewadarCountField.value !== '') {
        manualSewadarCount = parseInt(manualSewadarCountField.value);
      }
      const data = {
        Id: id,
        Date: document.getElementById('dacDate').value,
        CenterId: document.getElementById('dacCenterId').value,
        SewaTypeId: document.getElementById('dacSewaTypeId').value,
        Count: document.getElementById('dacCount').value,
        NominalRollToken: document.getElementById('dacNominalRollToken').value,
        ManualSewadarCount: manualSewadarCount
      };
      fetch('/DailyActualCount/Save', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'RequestVerificationToken': token
        },
        body: JSON.stringify(data)
      })
        .then(r => r.json())
        .then(res => {
          if (res.success) window.location.reload();
          else alert(res.message);
        });
    }
  </script>
}